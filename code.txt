// Google Apps Script backend for Henry's Kitchen Pre-orders
// To deploy:
// 1. Open a new script project at script.google.com.
// 2. Create a new Google Sheet to store your orders.
// 3. In the script editor, go to File > New > Script file, and name it Code.gs.
// 4. Replace the content of Code.gs with this script.
// 5. Go to Deploy > New deployment.
// 6. Select "Web app" as the type.
// 7. In the configuration, set "Execute as" to "Me" and "Who has access" to "Anyone".
// 8. Click "Deploy".
// 9. Grant the necessary permissions for the script to access your Google Sheet.
// 10. Copy the Web app URL provided.
// 11. Paste this URL into the SCRIPT_URL constants in `admin/index.html` and `components/ShoppingCart.tsx`.

var SHEET_NAME = "Orders";

// This function runs when a GET request is made to the script URL
function doGet(e) {
  var action = e.parameter.action;

  if (action == 'getOrders') {
    return getOrders();
  }
  
  // Return a generic error for other GET requests
  return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'Invalid GET action' })).setMimeType(ContentService.MimeType.JSON);
}

// This function runs when a POST request is made to the script URL
function doPost(e) {
  var action = e.parameter.action;

  if (action == 'updateStatus') {
    return updateOrderStatus(e);
  }
  
  // If no action, assume it's a new order submission
  return handleNewOrder(e);
}

// Function to handle a new pre-order
function handleNewOrder(e) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    // If the sheet doesn't exist, create it with headers
    if (!sheet) {
        sheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet(SHEET_NAME);
        sheet.appendRow(["Timestamp", "Order ID", "Customer Name", "Email", "Phone", "Pickup Time", "Order Items", "Subtotal", "Service Fee", "Total Amount", "Status"]);
    }
    
    var orderDetailsParsed = JSON.parse(e.parameter.orderDetails);
    var orderItems = orderDetailsParsed.map(function(item) {
        return item.quantity + "x " + item.name;
    }).join('; ');

    var orderId = generateOrderId();

    // Append the new order data as a new row
    sheet.appendRow([
      new Date(),
      orderId,
      e.parameter.customerName,
      e.parameter.customerEmail,
      e.parameter.customerPhone,
      new Date(e.parameter.pickupTime),
      orderItems,
      e.parameter.subtotal,
      e.parameter.serviceFee,
      e.parameter.total,
      "Pending" // Default status for new orders
    ]);
    
    // While no-cors won't let the client see this, it's good practice for API design.
    return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: 'Order received', orderId: orderId })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log(error);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Function to fetch all orders for the admin panel
function getOrders() {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({ status: 'success', data: [] })).setMimeType(ContentService.MimeType.JSON);
    }

    var data = sheet.getDataRange().getValues();
    if (data.length < 2) {
        return ContentService.createTextOutput(JSON.stringify({ status: 'success', data: [] })).setMimeType(ContentService.MimeType.JSON);
    }

    var headers = data.shift(); // Get headers
    
    var orders = data.map(function(row) {
      var order = {};
      headers.forEach(function(header, index) {
        // Handle Date objects properly for JSON serialization
        if (row[index] instanceof Date) {
          order[header] = row[index].toISOString();
        } else {
          order[header] = row[index];
        }
      });
      return order;
    });

    // Return newest orders first for the admin panel display
    return ContentService.createTextOutput(JSON.stringify({ status: 'success', data: orders.reverse() })).setMimeType(ContentService.MimeType.JSON);
  } catch(error) {
    Logger.log(error);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Function to update the status of an order from the admin panel
function updateOrderStatus(e) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    var orderId = e.parameter.orderId;
    var newStatus = e.parameter.status;

    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    var orderIdColIndex = headers.indexOf("Order ID");
    var statusColIndex = headers.indexOf("Status");
    
    if (orderIdColIndex === -1 || statusColIndex === -1) {
        throw new Error("Required columns ('Order ID' or 'Status') not found in the sheet.");
    }

    // Find the row with the matching Order ID and update its status
    // Start from 1 to skip header row
    for (var i = 1; i < data.length; i++) {
      if (data[i][orderIdColIndex] == orderId) {
        // The range is 1-indexed, and we need to account for the header row (i+1)
        sheet.getRange(i + 1, statusColIndex + 1).setValue(newStatus);
        return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: 'Status updated successfully' })).setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    throw new Error("Order ID '" + orderId + "' not found.");

  } catch(error) {
    Logger.log(error);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}


// Function to generate a simple unique Order ID
function generateOrderId() {
    // Generates an ID like "HK-a1b2c3d"
    return "HK-" + Math.random().toString(36).substr(2, 7);
}
